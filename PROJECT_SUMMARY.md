# é¡¹ç›®å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. **é¡¹ç›®æ¶æ„æ­å»º**
- âœ… å¾®æœåŠ¡ç›®å½•ç»“æ„ (`cmd/`, `internal/`, `pkg/`, `api/proto/`)
- âœ… Go Modules ä¾èµ–ç®¡ç†
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ (Viper + ç¯å¢ƒå˜é‡)
- âœ… æ—¥å¿—ç³»ç»Ÿ (Zap ç»“æ„åŒ–æ—¥å¿—)
- âœ… æšä¸¾ç±»å‹å®šä¹‰ (ConversationType, ConversationRole)

### 2. **æœåŠ¡æ³¨å†Œä¸å‘ç°**
- âœ… Consul é›†æˆ
- âœ… æœåŠ¡è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€
- âœ… å¥åº·æ£€æŸ¥ä¸å¿ƒè·³
- âœ… æœåŠ¡å‘ç°å®¢æˆ·ç«¯
- âœ… æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

### 3. **User æœåŠ¡ï¼ˆè®¤è¯ä¸­å¿ƒï¼‰**
- âœ… ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- âœ… JWT Token ç”Ÿæˆä¸éªŒè¯
- âœ… å¯†ç  bcrypt åŠ å¯†
- âœ… ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- âœ… gRPC æœåŠ¡å®ç°
- âœ… PostgreSQL æ•°æ®æŒä¹…åŒ–

### 4. **Router æœåŠ¡ï¼ˆè·¯ç”±ä¸­å¿ƒï¼‰**
- âœ… ç”¨æˆ·è·¯ç”±æ³¨å†Œ
- âœ… å¤šè®¾å¤‡åœ¨çº¿ç®¡ç†
- âœ… å¿ƒè·³ä¿æ´»æœºåˆ¶
- âœ… åœ¨çº¿çŠ¶æ€æŸ¥è¯¢
- âœ… Redis TTL è‡ªåŠ¨è¿‡æœŸ
- âœ… gRPC æœåŠ¡å®ç°

### 5. **æ•°æ®åº“è®¾è®¡**
- âœ… PostgreSQL åˆ†åŒºè¡¨è®¾è®¡
  - messages è¡¨æŒ‰å¤©åˆ†åŒº
  - files è¡¨æŒ‰å¤©åˆ†åŒº
  - è‡ªåŠ¨åˆ›å»º/åˆ é™¤åˆ†åŒºï¼ˆ30å¤©ä¿ç•™ï¼‰
- âœ… ç”¨æˆ·è¡¨ã€ä¼šè¯è¡¨ã€ä¼šè¯æˆå‘˜è¡¨
- âœ… åºåˆ—ç”Ÿæˆå‡½æ•°
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬

### 6. **Proto å®šä¹‰**
- âœ… User Service proto
- âœ… Router Service proto
- âœ… Message Service proto
- âœ… Gateway Service proto
- âœ… æ”¯æŒå›¾æ–‡æ··æ’æ¶ˆæ¯ä½“ (JSONB)

### 7. **åŸºç¡€è®¾æ–½**
- âœ… PostgreSQL è¿æ¥æ± 
- âœ… Redis å®¢æˆ·ç«¯
- âœ… JWT è®¤è¯åŒ…
- âœ… é…ç½®åŠ è½½å™¨
- âœ… æ—¥å¿—å·¥å…·

### 8. **éƒ¨ç½²é…ç½®**
- âœ… Docker Compose é…ç½®
  - PostgreSQL
  - Redis
  - Consul
  - MinIO
  - æ‰€æœ‰å¾®æœåŠ¡
- âœ… Dockerfile (User, Router)
- âœ… Makefile æ„å»ºè„šæœ¬
- âœ… ç¯å¢ƒå˜é‡é…ç½®

### 9. **æ–‡æ¡£**
- âœ… README å¼€å‘æŒ‡å—
- âœ… API æ–‡æ¡£è¯´æ˜
- âœ… æ¶æ„å›¾
- âœ… å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš§ å¾…å®ç°çš„åŠŸèƒ½

### 1. **Message æœåŠ¡**
éœ€è¦å®ç°:
- æ¶ˆæ¯å‘é€ä¸å­˜å‚¨
- å¢é‡æ‹‰å–é€»è¾‘
- ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ï¼‰
- Seq åºåˆ—ç”Ÿæˆ
- ä¸ Router æœåŠ¡é›†æˆï¼ˆæ¨é€é€šçŸ¥ï¼‰
- gRPC æœåŠ¡å®ç°

æ ¸å¿ƒæ–‡ä»¶ä½ç½®:
```
internal/message/
â”œâ”€â”€ repository.go    # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ service.go       # ä¸šåŠ¡é€»è¾‘
â””â”€â”€ grpc_server.go   # gRPC æœåŠ¡

cmd/message/main.go  # å¯åŠ¨å…¥å£
```

### 2. **Gateway æœåŠ¡**
éœ€è¦å®ç°:
- gRPC åŒå‘æµè¿æ¥
- æ¶ˆæ¯è·¯ç”±è½¬å‘
- JWT è®¤è¯æ‹¦æˆªå™¨
- ä¸ Message/Router/User æœåŠ¡é›†æˆ
- æ¨é€é€šçŸ¥åˆ†å‘

æ ¸å¿ƒæ–‡ä»¶ä½ç½®:
```
internal/gateway/
â”œâ”€â”€ connection.go    # è¿æ¥ç®¡ç†
â”œâ”€â”€ handler.go       # æ¶ˆæ¯å¤„ç†
â”œâ”€â”€ interceptor.go   # è®¤è¯æ‹¦æˆªå™¨
â””â”€â”€ grpc_server.go   # gRPC æœåŠ¡

cmd/gateway/main.go  # å¯åŠ¨å…¥å£
```

### 3. **File æœåŠ¡**
éœ€è¦å®ç°:
- S3 æ–‡ä»¶ä¸Šä¼ 
- æ–‡ä»¶å…ƒæ•°æ®ç®¡ç†
- RESTful API (Gin)
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ500MBï¼‰
- MIME ç±»å‹éªŒè¯
- CDN URL è¿”å›

æ ¸å¿ƒæ–‡ä»¶ä½ç½®:
```
internal/file/
â”œâ”€â”€ repository.go    # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ s3.go           # S3 å®¢æˆ·ç«¯
â”œâ”€â”€ handler.go      # HTTP å¤„ç†å™¨
â””â”€â”€ server.go       # REST æœåŠ¡

cmd/file/main.go    # å¯åŠ¨å…¥å£
```

### 4. **Dockerfile è¡¥å……**
éœ€è¦åˆ›å»º:
- `deployments/docker/Dockerfile.message`
- `deployments/docker/Dockerfile.gateway`
- `deployments/docker/Dockerfile.file`

### 5. **gRPC æ‹¦æˆªå™¨**
éœ€è¦å®ç°:
```go
pkg/interceptor/
â”œâ”€â”€ auth.go         # JWT è®¤è¯æ‹¦æˆªå™¨
â”œâ”€â”€ logging.go      # æ—¥å¿—æ‹¦æˆªå™¨
â””â”€â”€ recovery.go     # é”™è¯¯æ¢å¤æ‹¦æˆªå™¨
```

### 6. **æµ‹è¯•**
éœ€è¦æ·»åŠ :
- å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- gRPC å®¢æˆ·ç«¯æµ‹è¯•å·¥å…·

## ğŸ“ å½“å‰é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ api/proto/              # Protocol Buffers å®šä¹‰
â”‚   â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ router/
â”‚   â””â”€â”€ user/
â”œâ”€â”€ cmd/                    # æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ router/
â”‚   â”œâ”€â”€ user/
â”‚   â””â”€â”€ file/
â”œâ”€â”€ internal/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ router/
â”‚   â”œâ”€â”€ user/
â”‚   â””â”€â”€ file/
â”œâ”€â”€ pkg/                    # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ auth/              # JWT è®¤è¯
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database/          # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ logger/            # æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ redis/             # Redis å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ registry/          # Consul æ³¨å†Œ
â”‚   â””â”€â”€ types/             # æšä¸¾å®šä¹‰
â”œâ”€â”€ migrations/            # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ deployments/docker/    # Docker é…ç½®
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/               # è„šæœ¬å·¥å…·
â”œâ”€â”€ Makefile              # æ„å»ºè„šæœ¬
â”œâ”€â”€ go.mod                # Go ä¾èµ–
â”œâ”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
â””â”€â”€ éœ€æ±‚.md               # éœ€æ±‚æ–‡æ¡£
```

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼šMessage æœåŠ¡
è¿™æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå»ºè®®å…ˆå®ç°:
1. åˆ›å»º `internal/message/repository.go` - æ•°æ®åº“æ“ä½œ
2. åˆ›å»º `internal/message/service.go` - ä¸šåŠ¡é€»è¾‘
3. åˆ›å»º `internal/message/grpc_server.go` - gRPC å®ç°
4. åˆ›å»º `cmd/message/main.go` - æœåŠ¡å¯åŠ¨
5. åˆ›å»º `Dockerfile.message`

### ä¼˜å…ˆçº§ 2ï¼šGateway æœåŠ¡
å®ç°å®¢æˆ·ç«¯æ¥å…¥:
1. åˆ›å»ºè®¤è¯æ‹¦æˆªå™¨
2. å®ç°åŒå‘æµå¤„ç†
3. é›†æˆ Message/Router æœåŠ¡
4. åˆ›å»º `Dockerfile.gateway`

### ä¼˜å…ˆçº§ 3ï¼šFile æœåŠ¡
æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½:
1. é›†æˆ AWS S3 SDK
2. å®ç° RESTful API
3. æ–‡ä»¶å…ƒæ•°æ®ç®¡ç†
4. åˆ›å»º `Dockerfile.file`

### ä¼˜å…ˆçº§ 4ï¼šå®Œå–„ä¸ä¼˜åŒ–
1. æ·»åŠ å•å…ƒæµ‹è¯•
2. æ€§èƒ½å‹æµ‹
3. ç›‘æ§æŒ‡æ ‡
4. API æ–‡æ¡£å®Œå–„

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

1. **åˆ†åŒºè¡¨è‡ªåŠ¨ç®¡ç†**: å·²åœ¨ `pkg/database/postgres.go` å®ç°è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†åˆ†åŒº
2. **Consul å¥åº·æ£€æŸ¥**: é€šè¿‡ TTL å¿ƒè·³æœºåˆ¶ï¼ŒæœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œæ³¨é”€
3. **JWT è®¤è¯**: æ”¯æŒè®¾å¤‡çº§åˆ«çš„ Tokenï¼ŒåŒ…å« user_id å’Œ device_id
4. **Redis è·¯ç”±**: ä½¿ç”¨ Hash ç»“æ„å­˜å‚¨å¤šè®¾å¤‡è·¯ç”±ï¼ŒTTL 60s
5. **gRPC é€šä¿¡**: é«˜æ€§èƒ½ RPCï¼Œæ”¯æŒåŒå‘æµ

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡å»ºè®®

- æ¶ˆæ¯å»¶è¿Ÿ: P99 < 100ms
- QPS: æ”¯æŒ 10K+ æ¶ˆæ¯/ç§’
- å¹¶å‘è¿æ¥: å• Gateway æ”¯æŒ 10K+ é•¿è¿æ¥
- å­˜å‚¨: 30 å¤©æ¶ˆæ¯ä¿ç•™ï¼Œè‡ªåŠ¨æ¸…ç†
- é«˜å¯ç”¨: å¤šå®ä¾‹éƒ¨ç½²ï¼ŒConsul æœåŠ¡å‘ç°

## ğŸš€ å¿«é€Ÿå¯åŠ¨

```bash
# 1. å®‰è£…å·¥å…·
make install-tools

# 2. ç”Ÿæˆ Proto ä»£ç 
make proto

# 3. ä¸‹è½½ä¾èµ–
make deps

# 4. å¯åŠ¨åŸºç¡€è®¾æ–½
cd deployments/docker
docker-compose up -d postgres redis consul minio

# 5. è¿è¡Œæ•°æ®åº“è¿ç§»
psql -h localhost -U imuser -d im_system -f ../../migrations/001_init_schema.sql

# 6. å¯åŠ¨å·²å®Œæˆçš„æœåŠ¡
make build-user && make run-user
make build-router && make run-router
```

## ğŸ“ å¾…åŠäº‹é¡¹æ£€æŸ¥æ¸…å•

- [x] é¡¹ç›®ç»“æ„æ­å»º
- [x] é…ç½®ç®¡ç†
- [x] æ—¥å¿—ç³»ç»Ÿ
- [x] Consul é›†æˆ
- [x] User æœåŠ¡
- [x] Router æœåŠ¡
- [x] æ•°æ®åº“è®¾è®¡ä¸è¿ç§»
- [x] Docker é…ç½®
- [x] Makefile
- [x] README æ–‡æ¡£
- [ ] Message æœåŠ¡å®ç°
- [ ] Gateway æœåŠ¡å®ç°
- [ ] File æœåŠ¡å®ç°
- [ ] gRPC æ‹¦æˆªå™¨
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç›‘æ§å‘Šè­¦
