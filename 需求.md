# 📬 分布式 IM 系统（后端）需求与技术设计文档

**版本**：v1.2
**技术栈**：Golang + gRPC + PostgreSQL + Redis + S3
**架构风格**：微服务 + 分布式 + 无状态

---

## 🧭 一、系统总体目标

构建一个可水平扩展、高并发、低延迟的 **分布式 IM 后端系统**，提供以下核心能力：

* 📡 实时消息收发（文本、图片、语音、图文混排）
* 👥 支持单聊、群聊、频道三种会话类型
* 🪄 多设备在线状态同步
* 📁 文件上传至 S3（最大 500 MB）
* 📥 增量拉取消息，消息仅保留 **30 天**
* 🔔 推送“新消息通知” + 客户端主动拉取正文
* 📂 搜索由客户端完成，不由后端承担

---

## 🧩 二、微服务架构设计

| 服务          | 功能                         | 通信方式                   | 是否必选 |
| ----------- | -------------------------- | ---------------------- | ---- |
| 🛰️ Gateway | 消息收发入口（gRPC）、推送通知          | gRPC                   | ✅    |
| 📡 Router   | 用户 → Gateway 路由管理，在线状态维护   | gRPC + Redis           | ✅    |
| 💬 Message  | 消息接收、存储、分发、增量拉取            | gRPC + PostgreSQL      | ✅    |
| 🔐 User     | 注册、登录、Token、用户资料           | gRPC + PostgreSQL      | ✅    |
| 📁 File     | 文件上传（S3）、元数据管理、RESTful API | REST + S3 + PostgreSQL | ✅    |

📌 注意：

* **Gateway** 仅提供消息相关的 **gRPC 接口**，不提供 REST 或 WebSocket。
* **File** 服务提供 RESTful 接口（带 Token 鉴权），用于文件上传和获取 URL。

---

## 🗄️ 三、数据存储设计

### 1. PostgreSQL（结构化数据）

用于存储：

* 用户信息
* 会话元数据（单聊 / 群聊 / 频道）
* 30 天内的消息
* 文件元数据（30 天自动清理）

---

### (1) 会话与成员表

```sql
CREATE TYPE conv_type AS ENUM ('direct', 'group', 'channel');

CREATE TABLE conversations (
  id BIGSERIAL PRIMARY KEY,
  type conv_type NOT NULL,
  title TEXT,
  owner_id BIGINT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TYPE conv_role AS ENUM ('owner', 'admin', 'publisher', 'member', 'viewer');

CREATE TABLE conversation_members (
  conv_id BIGINT REFERENCES conversations(id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL,
  role conv_role NOT NULL DEFAULT 'member',
  muted BOOLEAN NOT NULL DEFAULT false,
  last_read_seq BIGINT NOT NULL DEFAULT 0,
  joined_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (conv_id, user_id)
);
```

---

### (2) 消息表（按天分区，保留 30 天）

```sql
CREATE TABLE messages (
  conv_id BIGINT NOT NULL,
  seq BIGINT NOT NULL,
  msg_id UUID PRIMARY KEY,
  sender_id BIGINT NOT NULL,
  conv_type conv_type NOT NULL,
  body JSONB NOT NULL,
  reply_to UUID,
  mentions BIGINT[] DEFAULT '{}',
  visibility TEXT DEFAULT 'normal',
  created_at TIMESTAMPTZ DEFAULT now()
) PARTITION BY RANGE (created_at);
```

索引：

```sql
CREATE INDEX idx_messages_conv_seq ON messages (conv_id, seq DESC);
CREATE INDEX idx_messages_sender_time ON messages (sender_id, created_at DESC);
```

📌 分区策略：

* 每天自动创建分区表 `messages_YYYY_MM_DD`
* 定时任务自动清理超过 30 天的分区

---

### (3) 文件元数据表（保留 30 天）

```sql
CREATE TABLE files (
  id UUID PRIMARY KEY,
  filename TEXT NOT NULL,
  size BIGINT NOT NULL,
  sender_id BIGINT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
) PARTITION BY RANGE (created_at);
```

* 仅包含：文件 ID、文件名、大小、发送人、创建时间
* 同样使用 **按天分区表**，自动清理 30 天前的分区
* URL 不存数据库，客户端通过返回值直接获取

---

### 2. Redis（高速状态）

| Key                      | 内容                   | TTL |
| ------------------------ | -------------------- | --- |
| `route:{user_id}`        | 当前用户在线设备和 Gateway 信息 | 60s |
| `presence:{user_id}`     | 在线状态（online/offline） | 60s |
| `conv_members:{conv_id}` | 热门会话成员缓存（可选）         | 30s |

---

## 📁 四、文件服务设计（S3）

### 1. 存储策略

* 使用 AWS S3 或兼容实现（MinIO、OSS、R2 等）
* 路径：`{env}/files/YYYY/MM/DD/{sha256_16}.{ext}`
* 生命周期：建议 **35 天自动过期**

### 2. 上传流程（REST）

1. 客户端携带 JWT 调用 `POST /v1/files` 上传文件（multipart/form-data）
2. File 服务校验大小（≤ 500 MB）、MIME 类型，并上传至 S3
3. 保存文件元数据到 PostgreSQL（file_id、filename、size、sender_id）
4. 返回文件 URL（CDN 域名）

📌 限制：

* `Content-Length` ≤ 524,288,000
* 需要 Bearer Token 鉴权
* 支持断点续传（可选 Multipart Upload）

---

## 📡 五、消息生命周期设计

### 1. 发送流程

* 客户端 → Gateway（gRPC）
* Gateway → Message 服务
* Message 生成 `seq`、存储消息
* Message 通知 Router 查找目标用户在线 Gateway
* Router → Gateway 推送 “新消息” 通知

---

### 2. 拉取流程

* 客户端收到通知后调用 `PullMessages(conv_id, since_seq)`（gRPC）
* Message 服务从 PostgreSQL 查询正文返回

📌 未收到通知也可以定期调用 `sync` 进行补拉。

---

## 💬 六、消息体设计（支持图文混排）

消息正文字段 `body` 为 JSON：

```json
{
  "type": "rich_text",
  "content": [
    {"type": "text", "text": "你好，这是一张图片："},
    {"type": "image", "url": "https://cdn.example.com/img/123.jpg", "width": 800, "height": 600},
    {"type": "text", "text": "图片后面还有文字"}
  ]
}
```

---

## 📶 七、Router 服务设计

* 维护「用户 → Gateway」映射
* TTL 自动过期（默认 60 秒）
* 支持多设备在线
* 提供 gRPC 接口：

  * `RegisterRoute`
  * `KeepAlive`
  * `GetRoute`
  * `UnregisterRoute`

---

## 🔐 八、鉴权与安全设计

* 全系统采用 **JWT** 鉴权

* 适用于所有 REST 接口和 gRPC Metadata

* 推荐字段：

  * `sub`: user_id
  * `exp`: 过期时间
  * `aud`: im-api
  * `device_id`: 设备标识

* 幂等：`x-idempotency-key`

* 防刷：速率限制（消息发送、文件上传）

---

## 📈 九、消息保留策略

* 所有消息与文件元数据仅保留 **30 天**
* 使用分区表每日自动创建和删除

## 📜 十一、模块概览（最终版）

| 模块          | 功能                     | 技术栈                         | 说明          |
| ----------- | ---------------------- | --------------------------- | ----------- |
| 🛰️ Gateway | 消息收发入口、推送通知（仅 gRPC）    | Go + gRPC                   | 不提供 REST/WS |
| 📡 Router   | 用户路由与在线状态管理            | Go + Redis                  | TTL + 多设备支持 |
| 💬 Message  | 消息存储、序列分配、增量拉取         | Go + PostgreSQL             | 单聊、群聊、频道    |
| 🔐 User     | 用户注册、登录、JWT 鉴权         | Go + PostgreSQL             |             |
| 📁 File     | 文件上传、S3 存储、元数据管理（REST） | Go + REST + S3 + PostgreSQL | 文件元数据每日分区清理 |
